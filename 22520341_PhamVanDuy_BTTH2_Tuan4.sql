CREATE DATABASE QLHV
USE QLHV

CREATE TABLE KHOA
(
  MAKHOA varchar(4) PRIMARY KEY,
  TENKHOA varchar(40),
  NGTLAP smalldatetime,
  TRGKHOA  char(4),
)

CREATE TABLE MONHOC
(
  MAMH varchar(10) PRIMARY KEY,
  TENMH varchar(40),
  TCLT tinyint,
  TCTH tinyint,
  MAKHOA varchar(4)
)

CREATE TABLE DIEUKIEN
( 
  MAMH varchar(10),
  MAMH_TRUOC varchar(10),
  CONSTRAINT DK_MAMH_MAMH_TRUOC_PK PRIMARY KEY (MAMH,MAMH_TRUOC)
)

CREATE TABLE GIAOVIEN
(
  MAGV char(4) PRIMARY KEY,
  HOTEN varchar(40) ,
  HOCVI varchar(10),
  HOCHAM varchar(10),
  GIOITINH varchar(3),
  NGSINH smalldatetime,
  NGVL smalldatetime,
  HESO numeric(4,2),
  MUCLUONG money,
  MAKHOA varchar(4)
)

CREATE TABLE LOP 
(
  MALOP char(3) PRIMARY KEY,
  TENLOP varchar(40),
  TRGLOP char(5),
  SISO tinyint,
  MAGVCN char(4),
)

CREATE TABLE HOCVIEN
( 
  MAHV char(5) PRIMARY KEY,
  HO varchar(40) ,
  TEN varchar(10) ,
  NGSINH smalldatetime,
  GIOITINH varchar(3),
  NOISINH varchar(40),
  MALOP char(3),
)

CREATE TABLE GIANGDAY
(
  MALOP char(3),
  MAMH varchar(10),
  MAGV char(4),
  HOCKY tinyint,
  NAM smallint,
  TUNGAY smalldatetime,
  DENNGAY smalldatetime,
  CONSTRAINT GIANGDAY_MALOP_MAMH_PK PRIMARY KEY(MALOP,MAMH)
)

CREATE TABLE KETQUATHI
(
  MAHV char(5),
  MAMH varchar(10),
  LANTHI tinyint,
  NGTHI smalldatetime,
  DIEM numeric(4,2),
  KQUA varchar(10)
  CONSTRAINT KETQUATHI_MAHV_MAMH_LANTHI_PK PRIMARY KEY(MAHV,MAMH,LANTHI)
)

ALTER TABLE HOCVIEN ADD CONSTRAINT HOCVIEN_MALOP_FK FOREIGN KEY (MALOP) REFERENCES LOP(MALOP)

ALTER TABLE LOP ADD
CONSTRAINT LOP_TRGLOP_FK FOREIGN KEY (TRGLOP) REFERENCES HOCVIEN(MAHV),
CONSTRAINT LOP_MAGVCN_FK FOREIGN KEY (MAGVCN) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE MONHOC ADD CONSTRAINT MONHOC_MAKHOA_FK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE KHOA ADD CONSTRAINT KHOA_TRGKHOA_FK FOREIGN KEY (TRGKHOA) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE DIEUKIEN ADD
CONSTRAINT DIEUKIEN_MAMH_FK FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
CONSTRAINT DIEUKIEN_MAMH_TRUOC_FK FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH)

ALTER TABLE GIAOVIEN ADD CONSTRAINT GIAOVIEN_MAKHOA_FK FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA)

ALTER TABLE GIANGDAY ADD
CONSTRAINT GIANGDAY_MALOP_FK FOREIGN KEY (MALOP) REFERENCES LOP(MALOP),
CONSTRAINT GIANGDAY_MAMH_FK FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
CONSTRAINT GIANGDAY_MAGV_FK FOREIGN KEY (MAGV) REFERENCES GIAOVIEN(MAGV)

ALTER TABLE KETQUATHI ADD
CONSTRAINT KETQUATHI_MAHV_FK FOREIGN KEY (MAHV) REFERENCES HOCVIEN(MAHV),
CONSTRAINT KETQUATHI_MAMH_FK FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH)

SET DATEFORMAT DMY 

INSERT INTO KHOA VALUES ('KHMT','Khoa Hoc May Tinh','07/06/2005',NULL)
INSERT INTO KHOA VALUES ('HTTT','He Thong Thong Tin','07/06/2005',NULL)
INSERT INTO KHOA VALUES ('CNPM','Cong Nghe Phan Mem','07/06/2005',NULL)
INSERT INTO KHOA VALUES ('MTT','Mang Va Truyen Thong','20/10/2005',NULL)
INSERT INTO KHOA VALUES ('KTMT','Ky Thuat May Tinh','20/12/2005',NULL) 

INSERT INTO GIAOVIEN VALUES ('GV01','Ho Thanh Son','PTS','GS','Nam','02/05/1950','11/01/2004','5.00',2250000,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV02','Tran Tam Thanh','TS','PGS','Nam','17/02/1965','20/04/2004','4.50',2025000,'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV03','Do Nghiem Phung','TS','GS','Nu','01/08/1950','23/09/2004','4.00',1800000,'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV04','Tran Nam Som','TS','PGS','Nam','22/02/1961','12/01/2005','4.50',2025000,'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV05','Mai Thanh Danh','ThS','GV','Nam','12/03/1958','12/01/2005','3.00',1350000,'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV06','Tran Doan Hung','TS','GV','Nam','11/03/1953','12/01/2005','4.50',2025000,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV07','Nguyen Minh Tien','ThS','GV','Nam','23/11/1971','01/03/2005','4.00',1800000,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV08','Le Thi Tran','KS','NULL','Nu','26/03/1974','01/03/2005','1.69',760500,'KHMT')
INSERT INTO GIAOVIEN VALUES ('GV09','Nguyen To Lan','ThS','GV','Nu','31/12/1966','01/03/2005','4.00',1800000,'HTTT')
INSERT INTO GIAOVIEN VALUES ('GV10','Le Tran Anh Loan','KS','NULL','Nu','17/07/1972','01/03/2005','1.86',837000,'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV11','Ho Thanh Tung','CN','GV','Nam','12/01/1980','15/05/2005','2.67',1201500,'MTT')
INSERT INTO GIAOVIEN VALUES ('GV12','Tran Van Anh','CN','NULL','Nu','29/03/1981','15/05/2005','1.69',760500,'CNPM')
INSERT INTO GIAOVIEN VALUES ('GV13','Nguyen Linh Dan','CN','NULL','Nu','23/05/1980','15/05/2005','1.69',760500,'KTMT')
INSERT INTO GIAOVIEN VALUES ('GV14','Truong Minh Chau','ThS','GV','Nu','30/11/1976','15/05/2005','3.00',1350000,'MTT')
INSERT INTO GIAOVIEN VALUES ('GV15','Le Ha Thanh','ThS','GV','Nam','04/05/1978','15/05/2005','3.00',1350000,'KHMT')

UPDATE KHOA
SET TRGKHOA='GV01'
WHERE MAKHOA='KHMT'

UPDATE KHOA
SET TRGKHOA='GV02'
WHERE MAKHOA='HTTT'

UPDATE KHOA
SET TRGKHOA='GV03'
WHERE MAKHOA='CNPM'

UPDATE KHOA
SET TRGKHOA='GV11'
WHERE MAKHOA='MTT'

UPDATE KHOA
SET TRGKHOA='GV13'
WHERE MAKHOA='KTMT'


INSERT INTO LOP VALUES ('K11','Lop 1 Khoa 1',NULL,'11','GV07')
INSERT INTO LOP VALUES ('K12','Lop 2 Khoa 1',NULL,'12','GV09')
INSERT INTO LOP VALUES ('K13','Lop 3 Khoa 1',NULL,'12','GV14')

INSERT INTO MONHOC VALUES ('THDC','Tin Hoc Dai Cuong','4','1','KHMT')
INSERT INTO MONHOC VALUES ('CTRR','Cau TRuc Roi Rac','5','0','KHMT')
INSERT INTO MONHOC VALUES ('CSDL','Co So Du Lieu','3','1','HTTT')
INSERT INTO MONHOC VALUES ('CTDLGT','Cau Truc Du Lieu Va Giai Thuat','3','1','KHMT')
INSERT INTO MONHOC VALUES ('PTTKTT','Phan Tich Thuet Ke Thuat Toan','3','0','KHMT')
INSERT INTO MONHOC VALUES ('DHMT','Do Hoa May Tinh','3','1','KHMT')
INSERT INTO MONHOC VALUES ('KTMT','Kien Truc May Tinh','3','0','KTMT')
INSERT INTO MONHOC VALUES ('TKCSDL','Thiet Ke Co So Du Lieu','3','1','HTTT')
INSERT INTO MONHOC VALUES ('PTTKHTTT','Phan Tich Thiet Ke He Thong Thong Tin','4','1','HTTT')
INSERT INTO MONHOC VALUES ('HDH','He Dieu Hanh','4','0','KHMT')
INSERT INTO MONHOC VALUES ('NMCNPM','Nhap Mon Cong Nghe Phan Mem','3','0','CNPM')
iNSERT INTO MONHOC VALUES ('LTCFW','Lap Trinh C For Win','3','1','CNPM')
INSERT INTO MONHOC VALUES ('LTHDT','Lap Trinh Huong Doi Tuong','3','1','CNPM')

INSERT INTO DIEUKIEN VALUES ('CSDL','CTRR')
INSERT INTO DIEUKIEN VALUES ('CSDL','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('CTDLGT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','CTDLGT')
INSERT INTO DIEUKIEN VALUES ('PTTKTT','THDC')
INSERT INTO DIEUKIEN VALUES ('DHMT','THDC')
INSERT INTO DIEUKIEN VALUES ('LTHDT','THDC')
INSERT INTO DIEUKIEN VALUES ('PTTKHTTT','CSDL')

INSERT INTO HOCVIEN VALUES ('K1101','Nguyen Van','A','27/01/1986','Nam','TPHCM','K11')
INSERT INTO HOCVIEN VALUES ('K1102','Tran Ngoc','Han','14/03/1986','Nu','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES ('K1103','Ha Duy','Lap','18/04/1986','Nam','Nghe An','K11')
INSERT INTO HOCVIEN VALUES ('K1104','Tran NGoc ','Linh','30/03/1986','Nu','Tay Ninh','K11')
INSERT INTO HOCVIEN VALUES ('K1105','Tran Minh','Long','27/02/1986','Nam','TPHCM','K11')
INSERT INTO HOCVIEN VALUES ('K1106','Le Nhat ','Minh','24/01/1986','Nam','TPHCM','K11')
INSERT INTO HOCVIEN VALUES ('K1107','Nguyen Nhu','Nhut','27/01/1986','Nam','Ha Noi','K11')
INSERT INTO HOCVIEN VALUES ('K1108','Nguyen Manh','Tam','27/02/1986','Nam','Kien Giang','K11')
INSERT INTO HOCVIEN VALUES ('K1109','Phan Thi Thanh','Tam','27/01/1986','Nu','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES ('K1110','Le Hoai','Thuong','05/02/1986','Nu','Can Tho','K11')
INSERT INTO HOCVIEN VALUES ('K1111','Le Ha','Vinh','25/12/1986','Nam','Vinh Long','K11')
INSERT INTO HOCVIEN VALUES ('K1201','NGuyen Van ','B','11/02/1986','Nam','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1202','Nguyen Thi Kim','Duyen','18/01/1986','Nu','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1203','Tran Thi Kim','Duyen','17/09/1986','Nu','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1204','Truong My','Hanh','19/05/1986','Nu','Dong Nai','K12')
INSERT INTO HOCVIEN VALUES ('K1205','Nguyen Thanh','Nam','17/04/1986','Nam','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1206','NGuyen Thi Truc ','Thanh','04/03/1986','Nu','Kien Giang','K12')
INSERT INTO HOCVIEN VALUES ('K1207','Tran Thi Bich ','Thuy','08/02/1986','Nu','Nghe An','K12')
INSERT INTO HOCVIEN VALUES ('K1208','Huynh Thi Kim','Trieu','08/04/1986','Nu','Tay Ninh','K12')
INSERT INTO HOCVIEN VALUES ('K1209','Pham Thanh','Trieu','23/02/1986','Nam','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1210','Ngo Thanh','Tuan','14/02/1986','Nam','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1211','Do Thi','Xuan','09/03/1986','Nu','Ha Noi','K12')
INSERT INTO HOCVIEN VALUES ('K1212','Le Thi Phi','Yen','12/03/1986','Nu','TPHCM','K12')
INSERT INTO HOCVIEN VALUES ('K1301','NGuyen Thi Kim','Cuc','09/06/1986','Nu','Kien Giang','K13')
INSERT INTO HOCVIEN VALUES ('K1302','Truong Thi My','Hien','18/03/1986','Nu','Nghe An','K13')
INSERT INTO HOCVIEN VALUES ('K1303','Le Duc','Hien','21/03/1986','Nam','Tay Ninh','K13')
INSERT INTO HOCVIEN VALUES ('K1304','Le Quang','Hien','18/04/1986','Nam','TPHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1305','Le Thi ','Huong','27/03/1986','Nu','TPHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1306','Nguyen Thai','Huu','30/03/1986','Nam','Ha Noi','K13')
INSERT INTO HOCVIEN VALUES ('K1307','Tran Minh','Man','28/05/1986','Nam','TPHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1308','Huynh Hieu','Nghia','08/04/1986','Nam','Kien Giang','K13')
INSERT INTO HOCVIEN VALUES ('K1309','Nguyen Trung ','Nghia','18/01/1987','Nam','Nghe An','K13')
INSERT INTO HOCVIEN VALUES ('K1310','Tran Thi Hong','Tham','22/04/1986','Nu','Tay Ninh','K13')
INSERT INTO HOCVIEN VALUES ('K1311','Tran Minh','Thuc','04/04/1986','Nam','TPHCM','K13')
INSERT INTO HOCVIEN VALUES ('K1312','Nguyen Thi Kim','Yen','07/09/1986','Nu','TPHCM','K13')

UPDATE LOP
SET TRGLOP='K1108'
WHERE MALOP='K11'

UPDATE LOP
SET TRGLOP='K1205'
WHERE MALOP='K12'

UPDATE LOP
SET TRGLOP='K1305'
WHERE MALOP='K13'

INSERT INTO GIANGDAY VALUES ('K11','THDC','GV07','1','2006','02/01/2006','12/05/2006')
INSERT INTO GIANGDAY VALUES ('K12','THDC','GV06','1','2006','02/01/2006','12/05/2006')
INSERT INTO GIANGDAY VALUES ('K13','THDC','GV15','1','2006','02/01/2006','12/05/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTRR','GV02','1','2006','09/01/2006','17/05/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTRR','GV02','1','2006','09/01/2006','17/05/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTRR','GV08','1','2006','09/01/2006','17/05/2006')
INSERT INTO GIANGDAY VALUES ('K11','CSDL','GV05','2','2006','01/06/2006','15/07/2006')
INSERT INTO GIANGDAY VALUES ('K12','CSDL','GV09','2','2006','01/06/2006','15/07/2006')
INSERT INTO GIANGDAY VALUES ('K13','CTDLGT','GV15','2','2006','01/06/2006','15/07/2006')
INSERT INTO GIANGDAY VALUES ('K13','CSDL','GV05','3','2006','01/08/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K13','DHMT','GV07','3','2006','01/08/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','CTDLGT','GV15','3','2006','01/08/2006','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K12','CTDLGT','GV15','3','2006','01/08/2007','15/12/2006')
INSERT INTO GIANGDAY VALUES ('K11','HDH','GV04','1','2007','02/01/2007','18/02/2007')
INSERT INTO GIANGDAY VALUES ('K12','HDH','GV04','1','2007','02/01/2007','20/03/2007')
INSERT INTO GIANGDAY VALUES ('K11','DHMT','GV07','1','2007','18/02/2007','20/03/2007')

INSERT INTO KETQUATHI VALUES ('K1305','CTRR','1','13/05/2006','10.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CSDL','1','20/07/2006','10.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTDLGT','1','28/12/2006','9.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','THDC','1','20/05/2006','9.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1101','CTRR','1','13/05/2006','9.50','Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL','1','20/07/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL','2','27/07/2006','4.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CSDL','3','10/08/2006','4.50','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT','1','28/12/2006','4.50','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT','2','05/01/2007','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTDLGT','3','15/01/2007','6.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1102','THDC','1','20/05/2006','5.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1102','CTRR','1','13/05/2006','7.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL','1','20/07/2006','3.50','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CSDL','2','27/07/2006','8.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTDLGT','1','28/12/2006','7.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','THDC','1','20/05/2006','8.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1103','CTRR','1','13/05/2006','6.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CSDL','1','20/07/2006','3.75','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTDLGT','1','28/12/2006','4.00','KHong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','THDC','1','20/05/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR','1','13/05/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR','2','20/05/2006','3.50','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1104','CTRR','3','30/06/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CSDL','1','20/07/2006','6.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTDLGT','1','28/12/2006','5.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1201','THDC','1','20/05/2006','8.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1201','CTRR','1','13/05/2006','9.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CSDL','1','20/07/2006','8.00','dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT','1','28/12/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTDLGT','2','05/01/2007','5.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC','1','20/05/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','THDC','2','27/05/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR','1','13/05/2006','3.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR','2','20/05/2006','4.00','Khong dat')
INSERT INTO KETQUATHI VALUES ('K1202','CTRR','3','30/06/2006','6.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CSDL','1','20/07/2006','9.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTDLGT','1','28/12/2006','9.50','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','THDC','1','20/05/2006','10','Dat')
INSERT INTO KETQUATHI VALUES ('K1203','CTRR','1','13/05/2006','10','Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CSDL','1','20/07/2006','8.50','Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTDLGT','1','28/12/2006','6.25','dat')
INSERT INTO KETQUATHI VALUES ('K1204','THDC','1','20/05/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1204','CTRR','1','13/05/2006','6.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CSDL','1','20/12/2006','4.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTDLGT','1','25/07/2006','8.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1301','THDC','1','20/05/2006','7.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1301','CTRR','1','13/05/2006','8.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CSDL','1','20/12/2006','6.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTDLGT','1','13/05/2006','5.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','THDC','1','20/05/2006','8.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1302','CTRR','1','13/05/2006','8.50','Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CSDL','1','20/12/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT','1','25/07/2006','4.50','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT','2','07/08/2006','4.00','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTDLGT','3','15/08/2006','4.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','THDC','1','20/05/2006','4.50','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR','1','13/05/2006','3.25','Khong Dat')
INSERT INTO KETQUATHI VALUES ('K1303','CTRR','2','20/05/2006','5.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CSDL','1','20/12/2006','7.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTDLGT','1','25/07/2006','9.75','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','THDC','1','20/05/2006','5.50','Dat')
INSERT INTO KETQUATHI VALUES ('K1304','CTRR','1','13/05/2006','5.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CSDL','1','20/12/2006','9.25','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','CTDLGT','1','25/07/2006','10.00','Dat')
INSERT INTO KETQUATHI VALUES ('K1305','THDC','1','20/05/2006','8.00','Dat')

--I.1
-- Them vao 3 thuoc tinh GHICHU, DIEMTB, XEPLOAI cho quan hOC HOCVIEN
ALTER TABLE HOCVIEN ADD GHICHU VARCHAR(50), DIEMTB NUMERIC(4,2), XEPLOAI VARCHAR(10)

--I.2 ma hoc vien la mot chuoi 5 ki tu ,3 ki tu dau la ma lop , 2 ki tu cuoi cung la so thu tu hoc vien trong lop
ALTER TABLE HOCVIEN
ADD CONSTRAINT CHECK_HV CHECK( SUBSTRING(MAHV,1,3) = MALOP AND LEN(MAHV) = 5 AND (SUBSTRING(MAHV,4,5) BETWEEN 0 AND 99))

--I.3 thuoc tinh GIOI TINH co gia tri la nam hoac nu
ALTER TABLE HOCVIEN ADD CONSTRAINT HV_GT CHECK( GIOITINH IN('Nam','Nu'))
ALTER TABLE GIAOVIEN ADD CONSTRAINT CHECK_GTGV CHECK (GIOITINH IN ('Nam', 'Nu'))

--I.4 diem so cua mot lan thi co gia tri tu 0 den 10 va can luu den hai so le
ALTER TABLE KETQUATHI ADD CONSTRAINT KQT_DIEM CHECK( DIEM>=0 AND DIEM<=10 AND RIGHT(CAST(DIEM AS VARCHAR), 3) LIKE '.__' )

--I.5 ket qua thi la dat neu diem tu 5-10 va khong dat neu diem nho hon 5
ALTER TABLE KETQUATHI ADD CONSTRAINT KQT_KQ CHECK( (KQUA = 'Dat' AND DIEM BETWEEN 5 AND 10) OR (KQUA = 'Khong dat' AND DIEM < 5))

--I.6 hoc vien thi mot mon toi da 3 lan
ALTER TABLE KETQUATHI ADD CONSTRAINT CHECK_LANTHI CHECK (LANTHI <= 3)

--I.7  hoc ky chi co gia tri tu 1 den 3
ALTER TABLE GIANGDAY ADD CONSTRAINT GD_HK CHECK( HOCKY BETWEEN 1 AND 3)

--I.8 hoc vi giao vien chi co the la CN, KS, Ths, TS, PTS
ALTER TABLE GIAOVIEN ADD CONSTRAINT GV_HOCVI CHECK( HOCVI IN( 'CN', 'KS', 'Ths', 'TS', 'PTS') )

--I.9 lop truong cua mot lop phai la thanh vien cua lop do
ALTER TABLE LOP
ADD CONSTRAINT KTLOPTRUONG CHECK(SUBSTRING(TRGLOP,1,3) = MALOP)

--I.10 truong khoa phai la giao vien thuoc khoa va co hoc vi TS, PTS	

--I.11  hoc vien it nhat la 18 tuoi
ALTER TABLE HOCVIEN ADD CONSTRAINT CHECK_TUOI CHECK (YEAR(GETDATE()) - YEAR(NGSINH) >= 18)

--I.12 Giang day co ngay bat dau phai nho hon ngay ket thuc
ALTER TABLE GIANGDAY ADD CONSTRAINT GIANGDAY_NBDNKT CHECK (TUNGAY <= DENNGAY)

--I.13 giao vien khi vao lam it nhat la 22 tuoi
ALTER TABLE GIAOVIEN ADD CONSTRAINT GV_DOTUOI CHECK( YEAR(GETDATE()) - YEAR(NGSINH) >= 22)

--I.14 tat ca tin chi li thuyet va tin chi thuc hanh chech lech nhau khong qua 5
ALTER TABLE MONHOC ADD CONSTRAINT CHECK_TCLTTH CHECK(ABS(TCLT - TCTH) <= 5)

--II.1 tang he so luong them 0.2 cho nhung giao vien truong khoa
UPDATE GIAOVIEN
SET HESO = HESO + 0.2
WHERE MAGV IN (SELECT TRGKHOA FROM KHOA )

--II.2 Cap nhat gia tri diem trung binh tat ca cac mon hoc cua moi hoc vien 
UPDATE HOCVIEN
SET DIEMTB =
(
	SELECT AVG(DIEM)
	FROM KETQUATHI
	WHERE LANTHI = (
	      SELECT MAX(LANTHI) 
		  FROM KETQUATHI
		  WHERE MAHV = KETQUATHI.MAHV
	)
	GROUP BY MAHV
	HAVING MAHV = HOCVIEN.MAHV
)

--II.3  cap nhat gia tri cho cot GHICHU la' Cam Thi' doi voi truong hop hoc vien co mot mon thi bat ky lan thu 3 va duoi 5 diem
UPDATE HOCVIEN
SET GHICHU ='Cam Thi'
WHERE MAHV IN 
(
	SELECT MAHV
	FROM KETQUATHI
	WHERE LANTHI = 3 AND DIEM < 5
)

--II.4 cap nhat gia tri xep loai cho HOCVIEN
UPDATE HOCVIEN
SET XEPLOAI =
(
	CASE 
		WHEN DIEMTB >= 9 THEN 'XS'
		WHEN DIEMTB >= 8 AND DIEMTB < 9 THEN 'G'
		WHEN DIEMTB >= 6.5 AND DIEMTB < 8 THEN 'K'
		WHEN DIEMTB >= 5 AND DIEMTB < 6.5 THEN 'TB'
		WHEN DIEMTB < 5 THEN 'Y'
	END
)

--III.1 in ra danh sach lop truong cac lop 
SELECT MAHV, HO + ' '+ TEN AS 'HO TEN', NGSINH, MALOP
FROM HOCVIEN
WHERE MAHV IN(
     SELECT TRGLOP
	 FROM LOP
)

--III.2 in ra bang diem khi thi cua mon CTRR cua lop 'k12' sap sep theo ten, ho hoc vien
SELECT HOCVIEN.MAHV, HO + ' '+ TEN AS 'HO TEN', LANTHI, DIEM
FROM HOCVIEN, KETQUATHI
WHERE KETQUATHI.MAMH = 'CTRR' 
      AND MALOP='K12' AND KETQUATHI.MAHV = HOCVIEN.MAHV
	  ORDER BY TEN,HO

--III.3 in ra danh sach hoc vien va nhung mon hoc ma hoc vien thi an thu nhat da dat
SELECT HOCVIEN.MAHV, HO + ' '+ TEN AS 'HO TEN', MONHOC.TENMH
FROM HOCVIEN, KETQUATHI,MONHOC
WHERE MONHOC.MAMH=KETQUATHI.MAMH AND KETQUATHI.MAHV = HOCVIEN.MAHV AND LANTHI = 1 AND KQUA ='Dat'

--III.4 in ra danh sach hoc vien cua lop 'k11' thi mon CTRR khong dat (o lan thi 1)
SELECT HOCVIEN.MAHV, HO + ' '+ TEN AS 'HO TEN'
FROM HOCVIEN, KETQUATHI
WHERE  MALOP = 'K11' AND MAMH = 'CTRR' AND KETQUATHI.MAHV = HOCVIEN.MAHV AND LANTHI = 1 AND KQUA ='Khong Dat'

--III.5 danh sach hoc vien cua lop 'k' thi mon CTRR khong dat (o tat ca cac lan thi)
SELECT HOCVIEN.MAHV,  HO + ' '+ TEN AS 'HO TEN'
FROM HOCVIEN,KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
      AND MALOP LIKE 'K%'
	  AND MAMH = 'CTRR'
	  AND NOT EXISTS ( SELECT *
	                   FROM KETQUATHI
					   WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
					         AND MAMH ='CTRR'
							 AND KQUA ='Dat'
					 )

--III.6 tim ten nhung giao vien co ten 'Tran Tam Thanh' day trong hoc ky I nam 2006
SELECT DISTINCT TENMH
FROM MONHOC,GIANGDAY,GIAOVIEN
WHERE MONHOC.MAMH = GIANGDAY.MAMH AND GIAOVIEN.MAGV = GIANGDAY.MAGV AND HOCKY = '1' AND NAM = '2006' AND GIAOVIEN.HOTEN = 'Tran Tam Thanh'

--III.7 tim nhung mon hoc ma giao vien chu nhiem lop 'K11' day trong hoc ky 1 nam 2006
SELECT DISTINCT MONHOC.MAMH, TENMH
FROM MONHOC,GIANGDAY,LOP
WHERE MONHOC.MAMH = GIANGDAY.MAMH AND LOP.MAGVCN = GIANGDAY.MAGV AND LOP.MALOP = 'K11' AND HOCKY = '1' AND NAM = '2006'

--III.8 tim ho ten lop truong cua cac lop ma giao vien co ten 'Nguyen To Lan' DAY MON 'Co So Du Lieu'
SELECT DISTINCT  HO + ' '+ TEN AS 'HO TEN'
FROM GIAOVIEN, GIANGDAY, HOCVIEN ,LOP,MONHOC
WHERE GIANGDAY.MAGV = GIAOVIEN.MAGV 
      AND LOP.TRGLOP = HOCVIEN.MAHV
	  AND GIANGDAY.MALOP = LOP.MALOP
	  AND GIANGDAY.MAMH = MONHOC.MAMH
      AND GIAOVIEN.HOTEN = 'Nguyen To Lan' 
	  AND TENMH = 'Co So Du Lieu'

--III.9 in ra danh sach mon hoc phai hoc lien truoc mon 'Co So Du Lieu'
SELECT
	MONHOCTRUOC.MAMH, MONHOCTRUOC.TENMH
FROM
	MONHOC, MONHOC AS MONHOCTRUOC, DIEUKIEN
WHERE
	MONHOC.MAMH = DIEUKIEN.MAMH
	AND MONHOCTRUOC.MAMH = DIEUKIEN.MAMH_TRUOC
	AND MONHOC.TENMH = 'Co So Du Lieu'

--III.10 mon CTRR la mon hoc bat buoc phai hoc lien truoc nhung mon hoc nao
SELECT
	MONHOCSAU.MAMH, MONHOCSAU.TENMH
FROM
	MONHOC, MONHOC AS MONHOCSAU, DIEUKIEN
WHERE
	MONHOC.MAMH = DIEUKIEN.MAMH_TRUOC
	AND MONHOCSAU.MAMH = DIEUKIEN.MAMH
	AND MONHOC.TENMH = 'Cau Truc Roi Rac'

--III.11 tim ho ten giao vien giang day mon CTRR cho ca hai lop k11 va k12 trong hoc ki 1 nam 2006
SELECT HOTEN
FROM GIAOVIEN, GIANGDAY AS GD1, GIANGDAY AS GD2
WHERE GIAOVIEN.MAGV = GD1.MAGV AND GD1.MALOP LIKE 'K11'
      AND GIAOVIEN.MAGV = GD2.MAGV AND GD2.MALOP LIKE 'K12'
	  AND GD1.NAM = GD2.NAM AND GD1.HOCKY = GD2.HOCKY
	  AND GD1.NAM = '2006' AND GD1.HOCKY = '1'
--III.12 tim nhung hoc vien thi khong dat mon csdl o lan thi thu 1 nhung chua thi lai mon nay
SELECT HOCVIEN.MAHV,  HO + ' '+ TEN AS 'HO TEN'
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
      AND MAMH ='CTRR'
	  AND KQUA = 'Khong Dat' 
	  AND LANTHI = 1
	  AND NOT EXISTS ( SELECT *
	                   FROM KETQUATHI
					   WHERE LANTHI <> 1
					         AND HOCVIEN.MAHV = KETQUATHI.MAHV
					 )

--III.13 tim giao vien khong duoc phan cong giang day bat ky mon hoc nao
SELECT MAGV, HOTEN
FROM GIAOVIEN
EXCEPT
SELECT DISTINCT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV

--III.14 tim giao vien khong duoc phan cong giang day bat ky mon hoc nao thuoc khoa giao vien do phu trach
SELECT MAGV, HOTEN
FROM GIAOVIEN
WHERE NOT EXISTS
(
	SELECT *
	FROM MONHOC
	WHERE MONHOC.MAKHOA = GIAOVIEN.MAKHOA
	AND NOT EXISTS
	(
		SELECT *
		FROM GIANGDAY
		WHERE GIANGDAY.MAMH = MONHOC.MAMH
		AND GIANGDAY.MAGV = GIAOVIEN.MAGV
	)
)

--III.15 tim ho ten hoc vien thi mot mon qua 3 lan van khong dat hoac thi lan thu 2 mon ctrr duoc 5 diem
SELECT DISTINCT HO + ' '+ TEN AS 'HO TEN'
FROM HOCVIEN, KETQUATHI
WHERE MALOP = 'K11'
      AND HOCVIEN.MAHV = KETQUATHI.MAHV
      AND ((LANTHI = 2 AND MAMH = 'CTRR' AND DIEM = 5)
	       OR HOCVIEN.MAHV IN ( SELECT DISTINCT MAHV
		                        FROM KETQUATHI
								WHERE KQUA = 'Khong Dat'
								GROUP BY MAHV
								HAVING COUNT(*) > 3
	  ))

--III.16 tim ho ten giao vien day mon CTRR it nhat cho 2 lop trong cung mot hoc ky mon hoc
SELECT HOTEN
FROM GIAOVIEN, GIANGDAY
WHERE GIAOVIEN.MAGV = GIANGDAY.MAGV
      AND MAMH='CTRR'
GROUP BY GIAOVIEN.MAGV, HOTEN, HOCKY,NAM
HAVING COUNT(*)>=2

--III.17 danh sach hoc vien va diem thi mon csdl
SELECT HOCVIEN.*, DIEM
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
      AND MAMH = 'CSDL'
      AND LANTHI = (SELECT MAX(LANTHI)
	                FROM KETQUATHI
					WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
					      AND MAMH='CSDL')
	              
--III.18 danh sach hoc vien va diem thi mon 'co so du lieu' chi lay diem cao nhat
SELECT HOCVIEN.*, DIEM
FROM HOCVIEN, KETQUATHI
WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
      AND MAMH = 'CSDL'
      AND DIEM = (SELECT MAX(DIEM)
	                FROM KETQUATHI
					WHERE HOCVIEN.MAHV = KETQUATHI.MAHV
					      AND MAMH='CSDL')
--III.19 khoa nao duoc thanh lap som nhat
SELECT MAKHOA, TENKHOA
FROM KHOA
WHERE NGTLAP = (SELECT MIN(NGTLAP)
                FROM KHOA)
--III.20 co bao nhieu giao vien hoc ham gd va pgs
SELECT COUNT(*) AS PGS_GS
FROM GIAOVIEN
WHERE HOCHAM ='PGS' OR HOCHAM='GS'

--III.21 thong ke co bao nhieugiao vien co hoc vi cn,ks,ths,ts,pts
SELECT KHOA.MAKHOA,HOCVI, COUNT(*) AS THONGKE
FROM GIAOVIEN,KHOA
WHERE GIAOVIEN.MAKHOA = KHOA.MAKHOA
GROUP BY KHOA.MAKHOA,HOCVI
ORDER BY KHOA.MAKHOA DESC

--III.22 moi mon hoc thong ke so luong hoc vien theo ket qua dat khong dat
SELECT MONHOC.MAMH, KQUA, COUNT(*) AS SOLUONG
FROM MONHOC,KETQUATHI
WHERE MONHOC.MAMH = KETQUATHI.MAMH
GROUP BY MONHOC.MAMH, KQUA
ORDER BY MONHOC.MAMH DESC

--III.23 tim giao vien la giao vien chu nhiem cua 1 lop, dong thoi day cho lop do it nhat 1 mon
SELECT GIAOVIEN.MAGV, HOTEN
FROM GIAOVIEN, LOP, GIANGDAY
WHERE GIAOVIEN.MAGV = LOP.MAGVCN
      AND GIANGDAY.MALOP = LOP.MALOP
	  AND GIANGDAY.MAGV = GIAOVIEN.MAGV
GROUP BY GIAOVIEN.MAGV, HOTEN
HAVING COUNT(*)>=1

--III.24 tim ten lop truong co si so cao nhat 
SELECT HO + ' ' + TEN AS HOTEN
FROM HOCVIEN,LOP
WHERE HOCVIEN.MAHV = LOP.TRGLOP
      AND SISO = (SELECT MAX(SISO)
	              FROM LOP)

--III.25 tim ho ten lop truong thi khong dat qua 3 mon

-- chon ra lop truong cua cac lop
SELECT HO + ' ' + TEN AS HOTEN, L.TRGLOP
FROM LOP L, HOCVIEN H
WHERE L.TRGLOP = H.MAHV

-- chon ra lop truong thi khong dat qua 3 mon trong tat ca cac lan thi
SELECT LT.HOTEN
FROM(SELECT HO + ' ' + TEN AS HOTEN, L.TRGLOP
     FROM LOP L, HOCVIEN H
     WHERE L.TRGLOP = H.MAHV) LT, KETQUATHI KQ
WHERE LT.TRGLOP = KQ.MAHV
      AND LT.TRGLOP IN( SELECT HV.MAHV
	                    FROM HOCVIEN HV, KETQUATHI K
						WHERE HV.MAHV = K.MAHV
						AND KQUA ='Khong Dat'
						AND LANTHI = (SELECT MAX(LANTHI)
						              FROM HOCVIEN , KETQUATHI
									  WHERE HOCVIEN.MAHV = KETQUATHI.MAHV))
GROUP BY LT.HOTEN
HAVING COUNT(*)>=3

--III.26 tim hoc vien co mon dat diem 9,10 nhieu nhat
SELECT HV.MAHV, HO + ' ' + TEN AS HOTEN
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV 
      AND DIEM>=9
GROUP BY HV.MAHV, HO, TEN
HAVING COUNT(*) = (
SELECT TOP 1 COUNT(*)
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV
     AND DIEM>=9
GROUP BY HV.MAHV
ORDER BY COUNT(*) DESC)

--III.27 trong tung lop tim hoc vien co so mon dat diem 9,10 nhieu nhat
SELECT A.MAHV, A.HO + ' ' +A.TEN AS HOTEN
FROM (
SELECT HV.MAHV, MALOP, HO, TEN, RANK() OVER (PARTITION BY MALOP ORDER BY COUNT(*) DESC) AS XEPHANG
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV
      AND DIEM>=9
GROUP BY HV.MAHV,MALOP, HO, TEN) A
WHERE A.XEPHANG = 1

--III.28 trong tung hoc ky cua tung nam moi giao vien duoc phan cong day bao nhieu mon hoc, bao nhieu lop
SELECT GV.MAGV, HOTEN, COUNT(DISTINCT(MAMH)) AS SLMH, COUNT(DISTINCT(MALOP)) AS SLLOP, HOCKY, NAM
FROM GIAOVIEN GV, GIANGDAY GD
WHERE GV.MAGV = GD.MAGV
GROUP BY GV.MAGV, HOTEN, HOCKY, NAM
ORDER BY HOCKY DESC

--III.29 trong tung hoc ky cua tung nam moi giao vien duoc phan cong day nhieu nhat bao nhieu mon hoc, bao nhieu lop
SELECT HOCKY, NAM, A.MAGV, HOTEN
FROM GIAOVIEN,
(
	SELECT HOCKY, NAM, MAGV, RANK() OVER (PARTITION BY HOCKY, NAM  ORDER BY COUNT(*) DESC) AS XepHang
	FROM GIANGDAY
	GROUP BY HOCKY, NAM, MAGV
) AS A
WHERE
	A.MAGV = GiaoVien.MAGV
	AND XepHang = 1
ORDER BY
	Nam, HocKy

--III.30 tim mon hoc co nhieu nguoi khong thi khong dat o lan thi thu 1
SELECT TOP 1 WITH TIES MH.MAMH, TENMH
FROM MONHOC MH, KETQUATHI KQ
WHERE KQ.MAMH = MH.MAMH
AND LANTHI=1 AND KQUA='Khong Dat'
GROUP BY MH.MAMH,TENMH
ORDER BY COUNT(*) DESC

--III.31 tim hoc vien thi mon nao cx dat chi xet lan thi thu nhat
SELECT DISTINCT HV.MAHV, HO +' '+ TEN AS HOTEN
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV 
AND HV.MAHV NOT IN (
SELECT DISTINCT HV.MAHV
FROM  KETQUATHI KQ1, HOCVIEN HV
WHERE HV.MAHV = KQ1.MAHV 
AND LANTHI='1' AND KQUA='Khong Dat')

--III.32 tim hoc vien thi mon nao cung dat chi xet lan thi sau cung
SELECT DISTINCT HV.MAHV, HO +' '+ TEN AS HOTEN
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV 
AND HV.MAHV NOT IN(
SELECT DISTINCT HV.MAHV
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV 
AND LANTHI=(SELECT MAX(LANTHI)
            FROM KETQUATHI KQ1
			WHERE KQ1.MAHV=HV.MAHV)
AND KQUA='Khong Dat')

--III.33 tim hoc vien da thi tat ca cac mon deu dat xet lan thi thu nhat
SELECT MAHV, HO+' '+TEN AS HOTEN
FROM HOCVIEN HV
WHERE NOT EXISTS(
SELECT * 
FROM MONHOC MH
WHERE NOT EXISTS(
SELECT *
FROM KETQUATHI KQ
WHERE LANTHI='1'
AND KQUA='Dat'
AND HV.MAHV=KQ.MAHV
AND KQ.MAMH=MH.MAMH))

--III.34 tim hoc vien da thi tat ca cac mon deu dat xet lan thi cuoi cung
SELECT MAHV, HO+' '+TEN AS HOTEN
FROM HOCVIEN HV
WHERE NOT EXISTS(
SELECT * 
FROM MONHOC MH
WHERE NOT EXISTS(
SELECT *
FROM KETQUATHI KQ
WHERE LANTHI= (SELECT MAX(LANTHI)
               FROM KETQUATHI KQ1
			   WHERE KQ1.MAHV=HV.MAHV)
AND KQUA='Dat'
AND HV.MAHV=KQ.MAHV
AND KQ.MAMH=MH.MAMH))

--III.35 tim ho vien co diem thi cao nhat trong tung mon hoc lay diem thi o sau cung
SELECT MAHV, HO + ' ' +TEN , MAMH 
FROM(
SELECT HV.MAHV, HO, TEN, MAMH, RANK() OVER (PARTITION BY MAMH ORDER BY COUNT(*) DESC) AS XEPHANG
FROM HOCVIEN HV, KETQUATHI KQ
WHERE HV.MAHV = KQ.MAHV
AND LANTHI = (SELECT MAX(LANTHI)
              FROM KETQUATHI KQ1, HOCVIEN HV1
			  WHERE HV1.MAHV = KQ1.MAHV)
GROUP BY HV.MAHV, HO, TEN, MAMH) A
WHERE XEPHANG=1